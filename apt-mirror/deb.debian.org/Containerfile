# debian-12.Containerfile
FROM debian:12-slim

RUN apt-get update && apt-get install -y \
      apt-mirror ca-certificates xz-utils bzip2 gnupg curl perl \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Pull upstream apt-mirror script
RUN set -e; \
    saved="$(mktemp)"; \
    cp /usr/bin/apt-mirror "$saved"; \
    curl -fsSL https://raw.githubusercontent.com/apt-mirror/apt-mirror/master/apt-mirror \
      -o /usr/bin/apt-mirror && chmod +x /usr/bin/apt-mirror \
    || { mv "$saved" /usr/bin/apt-mirror; exit 1; }

# Guard against missing "Files:" stanza in Sources entries
# Replace every use of $lines{"Files:"} with a safe empty string fallback
RUN perl -0777 -pe 's/\$lines\{"Files:"\}/(exists $lines{"Files:"} ? $lines{"Files:"} : "")/g' \
      -i /usr/bin/apt-mirror

# (Optional) also guard direct splits on $lines{"Files:"} to avoid empty-split warnings
RUN perl -0777 -pe "s/split\\s*\\(\\s*\\n\\s*,\\s*\\$files\\s*\\)/length(\$files)?split(\"\\n\",\$files):()/g" \
      -i /usr/bin/apt-mirror || true

# Mirror root + entrypoint
RUN mkdir -p /srv/apt/apt-mirror
COPY sync-debian-mirror.sh /usr/local/bin/sync-debian-mirror.sh
RUN chmod +x /usr/local/bin/sync-debian-mirror.sh

VOLUME ["/srv/apt/apt-mirror"]
ENTRYPOINT ["/usr/local/bin/sync-debian-mirror.sh"]
