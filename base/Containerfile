# Base container image for mirror-sync operations
FROM debian:12-slim

LABEL maintainer="Mirror Sync Project"
LABEL description="Base image for Linux repository mirroring"

# Install common packages needed by all mirror tools
RUN apt-get update && apt-get install -y \
    ca-certificates \
    curl \
    wget \
    gnupg \
    xz-utils \
    bzip2 \
    perl \
    python3 \
    python3-pip \
    rsync \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Create common directories
RUN mkdir -p /srv/mirrors \
    && mkdir -p /opt/mirror-sync \
    && mkdir -p /var/log/mirror-sync

# Set up non-root user for security
RUN groupadd -r mirror && useradd -r -g mirror -d /opt/mirror-sync -s /bin/bash mirror

# Common environment variables
ENV MIRROR_USER=mirror
ENV MIRROR_HOME=/opt/mirror-sync
ENV PATH="/opt/mirror-sync/bin:${PATH}"

# Health check script
COPY healthcheck.sh /usr/local/bin/healthcheck.sh
RUN chmod +x /usr/local/bin/healthcheck.sh

HEALTHCHECK --interval=30m --timeout=10s --start-period=5m --retries=3 \
    CMD ["/usr/local/bin/healthcheck.sh"]

WORKDIR /opt/mirror-sync